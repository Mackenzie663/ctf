/* This file has been generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2014 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int init_proc();
// void setbuf(FILE *stream, char *buf);
// int printf(const char *format, ...);
// void free(void *ptr);
// char *fgets(char *s, int n, FILE *stream);
// int __cdecl _stack_chk_fail(_DWORD); weak
// size_t fread(void *ptr, size_t size, size_t n, FILE *stream);
// int puts(const char *s);
// void *malloc(size_t size);
// int _gmon_start__(void); weak
// void exit(int status);
// int atoi(const char *nptr);
// int strncmp(const char *s1, const char *s2, size_t n);
int sub_866C();
void sub_8690();
int *sub_86AC();
int print_menu();
int check_results();
int print_16bit();
char *input_secret();
char *input_name();
void thanks_goodbye();
int input_key();
void logic_controller();
int main();
int __fastcall sub_8B64(int a1, int a2, int a3);
void term_proc();

//-------------------------------------------------------------------------
// Data declarations

int (*off_10E44[2])() = { &sub_86AC, &sub_8690 }; // weak
int dword_10E4C = 0; // weak
int _stack_chk_guard; // weak
int stdin; // weak
int stdout; // weak
char byte_10FA8; // weak
_UNKNOWN unk_10FAC; // weak
int dword_10FB4; // weak
int dword_10FB8; // weak
int dword_10FBC; // weak
// extern _UNKNOWN __gmon_start__; weak


//----- (00008568) --------------------------------------------------------
int init_proc()
{
  return sub_866C();
}

//----- (00008630) --------------------------------------------------------
#error "863C: positive sp value has been found (funcsize=3)"

//----- (0000866C) --------------------------------------------------------
int sub_866C()
{
  int result; // r0@2

  if ( &__gmon_start__ )
    result = _gmon_start__();
  return result;
}
// 85F4: using guessed type int _gmon_start__(void);

//----- (00008690) --------------------------------------------------------
void sub_8690()
{
  if ( !byte_10FA8 )
    byte_10FA8 = 1;
}
// 10FA8: using guessed type char byte_10FA8;

//----- (000086AC) --------------------------------------------------------
int *sub_86AC()
{
  return &dword_10E4C;
}
// 10E4C: using guessed type int dword_10E4C;

//----- (000086DC) --------------------------------------------------------
int print_menu()
{
  puts("==============================================");
  puts("=    Welcome to super security strongbox     =");
  puts("==============================================");
  puts("= Update your key to make your secret safer! =");
  puts("==============================================");
  puts("1. update key.");
  puts("2. edit the secret.");
  puts("3. sign your name.");
  puts("4. leave & return.");
  return printf("Give me your choice(1-4):");
}

//----- (0000875C) --------------------------------------------------------
int check_results()

  int result; // r0@1f
  char s; // [sp+4h] [bp-28h]@1
  int v2; // [sp+24h] [bp-8h]@1

  v2 = _stack_chk_guard;
  fgets(&s, 32, (FILE *)stdin);
  result = atoi(&s);
  if ( v2 != _stack_chk_guard )
    _stack_chk_fail(result);
  return result;
}
// 85B8: using guessed type int __cdecl _stack_chk_fail(_DWORD);
// 10F98: using guessed type int _stack_chk_guard;
// 10FA0: using guessed type int stdin;

//----- (000087D0) --------------------------------------------------------
int print_16bit()
{
  if ( !dword_10FBC )
    dword_10FBC = (int)malloc(0x10u);
  printf("enter the new 16-bit key:");
  fread((void *)dword_10FBC, 1u, 0x10u, (FILE *)stdin);
  return puts("the key is updated!");
}
// 10FA0: using guessed type int stdin;
// 10FBC: using guessed type int dword_10FBC;

//----- (0000884C) --------------------------------------------------------
char *input_secret()
{
  if ( !dword_10FB4 )
    dword_10FB4 = (int)malloc(8u);
  printf("please input your secret:");
  return fgets((char *)dword_10FB4, 24, (FILE *)stdin);
}
// 10FA0: using guessed type int stdin;
// 10FB4: using guessed type int dword_10FB4;

//----- (000088B8) --------------------------------------------------------
char *input_name()
{
  char *result; // r0@2
  int size; // [sp+4h] [bp-8h]@3

  if ( dword_10FB8 )
  {
    result = (char *)puts("You have signed your name before!");
  }
  else
  {
    printf("please input your name length:");
    size = check_results();
    if ( size > 32 )
    {
      puts("how could you get such a long name ?!");
      exit(1);
    }
    dword_10FB8 = (int)malloc(size);
    printf("enter your name:");
    result = fgets((char *)dword_10FB8, size, (FILE *)stdin);
  }
  return result;
}
// 10FA0: using guessed type int stdin;
// 10FB8: using guessed type int dword_10FB8;

//----- (00008978) --------------------------------------------------------
void thanks_goodbye()
{
  puts("Thanks for using our service. Goodbye!");
  free((void *)dword_10FB4);
  free((void *)dword_10FB8);
  free((void *)dword_10FBC);
}
// 10FB4: using guessed type int dword_10FB4;
// 10FB8: using guessed type int dword_10FB8;
// 10FBC: using guessed type int dword_10FBC;

//----- (000089CC) --------------------------------------------------------
int input_key()
{
  int result; // r0@2
  signed int i; // [sp+4h] [bp-8h]@1

  for ( i = 0; ; ++i )
  {
    if ( i > 2 )
    {
      printf("lock the strongbox!");
      exit(1);
    }
    printf("please input your 8-bit key:");
    fread(&unk_10FAC, 1u, 8u, (FILE *)stdin);
    result = strncmp((const char *)&unk_10FAC, "security", 8u);
    if ( !result )
      break;
    printf("%s is wrong, try again!\n", &unk_10FAC);
  }
  return result;
}
// 10FA0: using guessed type int stdin;

//----- (00008A88) --------------------------------------------------------
void logic_controller()
{
  dword_10FB4 = (int)malloc(8u);
  input_key();
  while ( 1 )
  {
    print_menu();
    switch ( check_result() )
    {
      case 1:
        print_16bit();
        break;
      case 2:
        input_secret();
        break;
      case 3:
        input_name();
        break;
      case 4:
        thanks_goodbye();
        return;
      default:
        puts("wrong choice, select again!");
        break;
    }
  }
}
// 10FB4: using guessed type int dword_10FB4;

//----- (00008B1C) --------------------------------------------------------
int main()
{
  setbuf((FILE *)stdin, 0);
  setbuf((FILE *)stdout, 0);
  logic_controller();
  return 0;
}
// 10FA0: using guessed type int stdin;
// 10FA4: using guessed type int stdout;

//----- (00008B64) --------------------------------------------------------
int __fastcall sub_8B64(int a1, int a2, int a3)
{
  int v3; // r6@1
  int v4; // r5@1
  int v5; // r7@1
  int v6; // r8@1
  int result; // r0@1
  int v8; // r4@2
  int (__fastcall *v9)(_DWORD, _DWORD, _DWORD); // t1@3

  v3 = a1;
  v4 = (int)off_10E44;
  v5 = a2;
  v6 = a3;
  result = init_proc();
  if ( 4 >> 2 )
  {
    v8 = 0;
    do
    {
      v9 = *(int (__fastcall **)(_DWORD, _DWORD, _DWORD))v4;
      v4 += 4;
      ++v8;
      result = v9(v3, v5, v6);
    }
    while ( v8 != 4 >> 2 );
  }
  return result;
}
// 10E44: using guessed type int (*off_10E44[2])();

//----- (00008BC8) --------------------------------------------------------
void term_proc()
{
  ;
}

#error "There were 1 decompilation failure(s) on 16 function(s)"
